<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор продукции</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0088cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #006b9f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .cart-item {
            margin-top: 20px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Выбор продукции</h2>
        <div>
            <label>Склад:</label>
            <select id="stock">
                <option value="">Все</option>
                <option value="Екатеринбург">Екатеринбург</option>
                <option value="Москва">Москва</option>
                <option value="Челябинск">Челябинск</option>
                <option value="Санкт-Петербург">Санкт-Петербург</option>
            </select>
        </div>
        <div>
            <label>Тип:</label>
            <select id="type">
                <option value="">Все</option>
                <option value="Бесшовные холоднодеформированные">Бесшовные холоднодеформированные</option>
                <option value="Прямошовные">Прямошовные</option>
                <option value="Холоднокатаные">Холоднокатаные</option>
                <option value="Горячекатаные">Горячекатаные</option>
            </select>
        </div>
        <div>
            <label>Диаметр (мм):</label>
            <input type="number" id="diameter" step="0.01" placeholder="Введите диаметр">
        </div>
        <div>
            <label>Толщина стенки (мм):</label>
            <input type="number" id="wallThickness" step="0.01" placeholder="Введите толщину стенки">
        </div>
        <div>
            <label>ГОСТ:</label>
            <input type="text" id="gost" placeholder="Введите ГОСТ">
        </div>
        <div>
            <label>Марка стали:</label>
            <input type="text" id="steelGrade" placeholder="Введите марку стали">
        </div>
        <button onclick="fetchProducts()">Показать</button>

        <div id="products"></div>
        <div id="error" class="error"></div>

        <h3>Корзина</h3>
        <div id="cart"></div>
        <button onclick="showOrderForm()" style="display: none;" id="orderButton">Оформить заказ</button>

        <div id="orderForm" style="display: none;">
            <h3>Оформление заказа</h3>
            <div>
                <label>Имя:</label>
                <input type="text" id="firstName" placeholder="Введите имя">
            </div>
            <div>
                <label>Фамилия:</label>
                <input type="text" id="lastName" placeholder="Введите фамилию">
            </div>
            <div>
                <label>ИНН:</label>
                <input type="text" id="inn" placeholder="Введите ИНН">
            </div>
            <div>
                <label>Телефон:</label>
                <input type="text" id="phone" placeholder="Введите телефон">
            </div>
            <div>
                <label>Email:</label>
                <input type="email" id="email" placeholder="Введите email">
            </div>
            <button onclick="submitOrder()">Подтвердить заказ</button>
        </div>
    </div>

    <script>
        let cart = [];

        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Заполнение полей формы заказа данными из Telegram
        if (tg.initDataUnsafe.user) {
            document.getElementById('firstName').value = tg.initDataUnsafe.user.first_name || '';
            document.getElementById('lastName').value = tg.initDataUnsafe.user.last_name || '';
        }

        async function fetchProducts() {
            const stock = document.getElementById('stock').value;
            const type = document.getElementById('type').value;
            const diameter = document.getElementById('diameter').value;
            const wallThickness = document.getElementById('wallThickness').value;
            const gost = document.getElementById('gost').value;
            const steelGrade = document.getElementById('steelGrade').value;

            const query = new URLSearchParams();
            if (stock) query.append('stock', stock);
            if (type) query.append('type', type);
            if (diameter) query.append('diameter', diameter);
            if (wallThickness) query.append('wallThickness', wallThickness);
            if (gost) query.append('gost', gost);
            if (steelGrade) query.append('steelGrade', steelGrade);

            try {
                const response = await fetch(`https://amspp-5-165-20-11.a.free.pinggy.link/api/products?${query.toString()}`);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                const products = await response.json();
                displayProducts(products);
                document.getElementById('error').textContent = '';
            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('products').innerHTML = '';
            }
        }

        function displayProducts(products) {
            const productsDiv = document.getElementById('products');
            if (products.length === 0) {
                productsDiv.innerHTML = '<p>Товары не найдены.</p>';
                return;
            }

            let html = '<table>';
            html += '<tr><th>Название</th><th>ГОСТ</th><th>Марка стали</th><th>Диаметр (мм)</th><th>Толщина стенки (мм)</th><th>Тип</th><th>Склад</th><th>Цена (т)</th><th>В наличии (т)</th><th>Добавить в корзину</th></tr>';
            products.forEach(product => {
                html += `<tr>
                    <td>${product.name}</td>
                    <td>${product.gost}</td>
                    <td>${product.steelGrade}</td>
                    <td>${product.diameter}</td>
                    <td>${product.pipeWallThickness}</td>
                    <td>${product.typeName}</td>
                    <td>${product.stockCity}</td>
                    <td>${product.priceT}</td>
                    <td>${product.inStockT}</td>
                    <td>
                        <input type="number" id="quantityTons-${product.id}" step="0.01" min="0" placeholder="Тонны">
                        <input type="number" id="quantityMeters-${product.id}" step="0.01" min="0" placeholder="Метры">
                        <button onclick="addToCart('${product.id}', '${product.stockCity}')">Добавить</button>
                    </td>
                </tr>`;
            });
            html += '</table>';
            productsDiv.innerHTML = html;
        }

        async function addToCart(nomenclatureID, stockID) {
            const quantityTons = parseFloat(document.getElementById(`quantityTons-${nomenclatureID}`).value) || 0;
            const quantityMeters = parseFloat(document.getElementById(`quantityMeters-${nomenclatureID}`).value) || 0;

            if (quantityTons === 0 && quantityMeters === 0) {
                document.getElementById('error').textContent = 'Укажите количество в тоннах или метрах.';
                return;
            }

            const cartItem = {
                nomenclatureID,
                stockID,
                quantityTons,
                quantityMeters
            };

            try {
                const response = await fetch('https://amspp-5-165-20-11.a.free.pinggy.link/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cartItem)
                });
                if (!response.ok) throw new Error('Ошибка добавления в корзину');
                const result = await response.json();
                cart.push(result);
                displayCart();
                document.getElementById('orderButton').style.display = 'block';
                document.getElementById('error').textContent = '';
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        }

        function displayCart() {
            const cartDiv = document.getElementById('cart');
            if (cart.length === 0) {
                cartDiv.innerHTML = '<p>Корзина пуста.</p>';
                return;
            }

            let html = '<table>';
            html += '<tr><th>Товар</th><th>Склад</th><th>Количество (т)</th><th>Количество (м)</th><th>Цена</th><th>Удалить</th></tr>';
            cart.forEach((item, index) => {
                html += `<tr>
                    <td>${item.nomenclatureID}</td>
                    <td>${item.stockID}</td>
                    <td>${item.quantityTons}</td>
                    <td>${item.quantityMeters}</td>
                    <td>${item.price}</td>
                    <td><button onclick="removeFromCart(${index})">Удалить</button></td>
                </tr>`;
            });
            html += '</table>';
            cartDiv.innerHTML = html;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            displayCart();
            if (cart.length === 0) {
                document.getElementById('orderButton').style.display = 'none';
            }
        }

        function showOrderForm() {
            document.getElementById('orderForm').style.display = 'block';
        }

        async function submitOrder() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const inn = document.getElementById('inn').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;

            const order = {
                firstName,
                lastName,
                inn,
                phone,
                email,
                items: cart
            };

            try {
                const response = await fetch('https://amspp-5-165-20-11.a.free.pinggy.link/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(order)
                });
                if (!response.ok) throw new Error('Ошибка оформления заказа');
                const result = await response.json();
                document.getElementById('error').textContent = '';
                alert('Заказ успешно оформлен!');
                cart = [];
                displayCart();
                document.getElementById('orderButton').style.display = 'none';
                document.getElementById('orderForm').style.display = 'none';
                tg.close();
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        }
    </script>
</body>
</html>